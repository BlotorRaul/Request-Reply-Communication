services:
  # PostgreSQL pentru auth-service
  postgres-auth:
    image: postgres:15-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_DB: authDB
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d authDB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PostgreSQL pentru user-service
  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    environment:
      POSTGRES_DB: userDB
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d userDB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PostgreSQL pentru device-service
  postgres-device:
    image: postgres:15-alpine
    container_name: postgres-device
    environment:
      POSTGRES_DB: deviceDB
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
    volumes:
      - postgres_device_data:/var/lib/postgresql/data
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d deviceDB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # RabbitMQ service
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672" # Standard AMQP port
      - "15672:15672" # Management UI port
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8083:8083"  # Exposed for direct Swagger access: http://localhost:8083/swagger-ui.html
    environment:
      PORT: 8083
      DB_IP: postgres-auth
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: 1234
      DB_DBNAME: authDB
      AUTH_MODE: jwt
    depends_on:
      postgres-auth:
        condition: service_healthy
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/api/auth/users/mode || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "8081:8081"  # Exposed for direct Swagger access: http://localhost:8081/swagger-ui.html
    environment:
      PORT: 8081
      DB_IP: postgres-user
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: 1234
      DB_DBNAME: userDB
      AUTH_SERVICE_URL: http://auth-service:8083
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres-user:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8081 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Device Service
  device-service:
    build:
      context: ./device-service
      dockerfile: Dockerfile
    container_name: device-service
    ports:
      - "8082:8082"  # Exposed for direct Swagger access: http://localhost:8082/swagger-ui.html
    environment:
      PORT: 8082
      DB_IP: postgres-device
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: 1234
      DB_DBNAME: deviceDB
      AUTH_SERVICE_URL: http://auth-service:8083
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres-device:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8082 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Frontend (Angular)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Traefik (Reverse Proxy / Load Balancer)
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    ports:
      - "80:80"     # The HTTP port for frontend and API
      - "8080:8080" # The Web UI (Dashboard)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro" # So Traefik can discover services
      - "./traefik/traefik.yml:/etc/traefik/traefik.yml:ro" # Static configuration
      - "./dynamic:/etc/traefik/dynamic:ro" # Dynamic configuration
      - "./traefik/logs:/var/log/traefik" # Log files
    networks:
      - proxy-network
    depends_on:
      frontend:
        condition: service_started
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      device-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/overview || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  proxy-network:
    driver: bridge

volumes:
  postgres_auth_data:
  postgres_user_data:
  postgres_device_data:
  rabbitmq_data:
